<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Engine Demo - Realizability Analysis</title>
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --accent-cyan: #4FD1C5;
            --accent-coral: #F87171;
            --accent-green: #10B981;
            --accent-orange: #F97316;
            --accent-blue: #3B82F6;
            --accent-purple: #8B5CF6;
            --text-primary: #e0e0e0;
            --text-secondary: #9CA3AF;
            --border-color: #2d3a5c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        h1 {
            font-size: 2rem;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .panel-header {
            background: linear-gradient(90deg, var(--bg-tertiary), var(--bg-secondary));
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-header h2 {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .panel-icon {
            font-size: 1.2rem;
        }
        
        .panel-content {
            padding: 20px;
        }
        
        /* Graph Input Panel */
        .matrix-input-grid {
            display: grid;
            gap: 2px;
            background: var(--bg-primary);
            padding: 10px;
            border-radius: 8px;
            width: fit-content;
            margin: 0 auto 20px;
        }
        
        .matrix-row {
            display: flex;
            gap: 2px;
        }
        
        .matrix-cell {
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .matrix-cell:hover {
            border-color: var(--accent-cyan);
        }
        
        .matrix-cell.positive {
            background: rgba(79, 209, 197, 0.3);
            color: var(--accent-cyan);
        }
        
        .matrix-cell.negative {
            background: rgba(248, 113, 113, 0.3);
            color: var(--accent-coral);
        }
        
        .matrix-cell.diagonal {
            background: var(--bg-primary);
            cursor: not-allowed;
            color: #444;
        }
        
        .matrix-label {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: bold;
        }
        
        .preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .preset-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .preset-btn:hover {
            border-color: var(--accent-cyan);
            background: rgba(79, 209, 197, 0.1);
        }
        
        /* Results Panel */
        .status-card {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .status-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status-text.physical {
            color: var(--accent-green);
        }
        
        .status-text.non-physical {
            color: var(--accent-orange);
        }
        
        .dimensions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .dim-card {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .dim-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .dim-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Energy Display */
        .energy-display {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .energy-title {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .energy-bar {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            margin-bottom: 10px;
        }
        
        .energy-kinetic {
            background: linear-gradient(90deg, var(--accent-coral), var(--accent-orange));
            transition: width 0.3s;
        }
        
        .energy-potential {
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
            transition: width 0.3s;
        }
        
        .energy-values {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .energy-total {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-primary);
        }
        
        /* Violations */
        .violations-panel {
            background: rgba(248, 113, 113, 0.1);
            border: 1px solid rgba(248, 113, 113, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .violations-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-coral);
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .violations-list {
            margin: 0;
            padding-left: 20px;
            font-size: 12px;
            color: #FCA5A5;
        }
        
        /* Divergence Grid */
        .divergence-section {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .divergence-title {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .divergence-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .div-cell {
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .div-cell-label {
            font-size: 8px;
            opacity: 0.7;
        }
        
        .div-cell-value {
            font-size: 14px;
            font-weight: bold;
        }
        
        .div-cell.positive {
            background: rgba(248, 113, 113, 0.3);
            color: var(--accent-coral);
        }
        
        .div-cell.negative {
            background: rgba(79, 209, 197, 0.3);
            color: var(--accent-cyan);
        }
        
        .div-cell.zero {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .audit-btn {
            background: linear-gradient(135deg, var(--accent-blue), #1D4ED8);
            color: white;
        }
        
        .audit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .rectify-btn {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
        }
        
        .rectify-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .rectify-btn:disabled {
            background: #374151;
            color: #6B7280;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Matrix Display */
        .matrix-display {
            background: var(--bg-primary);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .matrix-display-header {
            padding: 10px 15px;
            background: var(--bg-tertiary);
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .matrix-display pre {
            padding: 15px;
            margin: 0;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 11px;
            line-height: 1.5;
            color: var(--accent-cyan);
            overflow-x: auto;
        }
        
        /* Theory Section */
        .theory-panel {
            grid-column: 1 / -1;
        }
        
        .theory-content {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 900px) {
            .theory-content {
                grid-template-columns: 1fr;
            }
        }
        
        .theory-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
        }
        
        .theory-card h3 {
            color: var(--accent-cyan);
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .theory-card p {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .formula {
            background: rgba(79, 209, 197, 0.1);
            padding: 10px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent-cyan);
            margin: 10px 0;
            text-align: center;
        }
        
        /* Console */
        .console-panel {
            grid-column: 1 / -1;
        }
        
        .console-output {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }
        
        .console-line {
            margin-bottom: 5px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .console-line.info {
            background: rgba(59, 130, 246, 0.1);
            color: #93C5FD;
        }
        
        .console-line.success {
            background: rgba(16, 185, 129, 0.1);
            color: #6EE7B7;
        }
        
        .console-line.warning {
            background: rgba(249, 115, 22, 0.1);
            color: #FDBA74;
        }
        
        .console-line.error {
            background: rgba(248, 113, 113, 0.1);
            color: #FCA5A5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öõÔ∏è Physics Engine Demo</h1>
            <p class="subtitle">Port-Hamiltonian Realizability Analysis for Graph Structures</p>
        </header>
        
        <div class="main-grid">
            <!-- Input Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">üìä</span>
                    <h2>Adjacency Matrix Input</h2>
                </div>
                <div class="panel-content">
                    <div class="preset-buttons">
                        <button class="preset-btn" onclick="loadPreset('triangle')">‚ñ≥ Triangle</button>
                        <button class="preset-btn" onclick="loadPreset('square')">‚ñ° Square</button>
                        <button class="preset-btn" onclick="loadPreset('path4')">‚Äï Path-4</button>
                        <button class="preset-btn" onclick="loadPreset('star4')">‚ú± Star-4</button>
                        <button class="preset-btn" onclick="loadPreset('k4')">K‚ÇÑ Complete</button>
                        <button class="preset-btn" onclick="loadPreset('broken')">‚ö† Broken</button>
                    </div>
                    
                    <div id="matrix-input"></div>
                    
                    <p style="font-size: 11px; color: var(--text-secondary); text-align: center; margin-top: 15px;">
                        Click cells to toggle edges. Skew-symmetric constraint enforced automatically.
                    </p>
                </div>
            </div>
            
            <!-- Results Panel -->
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-icon">üîç</span>
                    <h2>Realizability Analysis</h2>
                </div>
                <div class="panel-content">
                    <div class="status-card" id="status-card">
                        <div class="status-icon">‚è≥</div>
                        <div class="status-text">Click "Audit" to analyze</div>
                        <div class="status-subtitle">Load a graph and run analysis</div>
                    </div>
                    
                    <div class="dimensions-grid">
                        <div class="dim-card">
                            <div class="dim-label">Nodes (N)</div>
                            <div class="dim-value" id="dim-n">-</div>
                        </div>
                        <div class="dim-card">
                            <div class="dim-label">Edges (M)</div>
                            <div class="dim-value" id="dim-m">-</div>
                        </div>
                        <div class="dim-card">
                            <div class="dim-label">State Dim</div>
                            <div class="dim-value" id="dim-total">-</div>
                        </div>
                    </div>
                    
                    <div class="energy-display">
                        <div class="energy-title">Hamiltonian Energy (H = T + V)</div>
                        <div class="energy-bar">
                            <div class="energy-kinetic" id="energy-kinetic-bar" style="width: 50%"></div>
                            <div class="energy-potential" id="energy-potential-bar" style="width: 50%"></div>
                        </div>
                        <div class="energy-values">
                            <span style="color: var(--accent-coral)">T = <span id="kinetic-val">0.000</span></span>
                            <span style="color: var(--accent-cyan)">V = <span id="potential-val">0.000</span></span>
                        </div>
                        <div class="energy-total">H = <span id="total-energy">0.000</span> <span id="conservation-icon">‚úì</span></div>
                    </div>
                    
                    <div class="violations-panel" id="violations-panel" style="display: none;">
                        <div class="violations-header">
                            <span>‚ö†Ô∏è</span>
                            <span>Newton's Law Violations</span>
                        </div>
                        <ul class="violations-list" id="violations-list"></ul>
                    </div>
                    
                    <div class="divergence-section">
                        <div class="divergence-title">Nodal Divergence (‚àá¬∑F)</div>
                        <div class="divergence-grid" id="divergence-grid"></div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn audit-btn" onclick="runAudit()">
                            <span>üîç</span> Audit
                        </button>
                        <button class="action-btn rectify-btn" id="rectify-btn" onclick="runRectify()" disabled>
                            <span>üîß</span> Rectify
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Augmented Matrix Panel -->
            <div class="panel" style="grid-column: 1 / -1;">
                <div class="panel-header">
                    <span class="panel-icon">üìê</span>
                    <h2>Augmented System Matrix J</h2>
                </div>
                <div class="panel-content">
                    <div class="matrix-display">
                        <div class="matrix-display-header">
                            <span>Block Structure: J = [0, B; -B·µÄ, 0]</span>
                            <span id="matrix-dims">(N+M) √ó (N+M)</span>
                        </div>
                        <pre id="augmented-matrix">Run audit to see the augmented matrix...</pre>
                    </div>
                </div>
            </div>
            
            <!-- Theory Panel -->
            <div class="panel theory-panel">
                <div class="panel-header">
                    <span class="panel-icon">üìñ</span>
                    <h2>Port-Hamiltonian Theory</h2>
                </div>
                <div class="panel-content">
                    <div class="theory-content">
                        <div class="theory-card">
                            <h3>üéØ Physical Realizability</h3>
                            <p>A graph is <em>physically realizable</em> if it can represent a mechanical network (masses connected by springs). This requires:</p>
                            <div class="formula">‚àë·µ¢ B·µ¢‚±º = 0 for all edges j</div>
                            <p>Each edge (spring) must have exactly one +1 and one -1 entry (Newton's 3rd Law: equal and opposite forces).</p>
                        </div>
                        
                        <div class="theory-card">
                            <h3>‚ö° Energy Conservation</h3>
                            <p>The Hamiltonian (total energy) is conserved because J is skew-symmetric:</p>
                            <div class="formula">dH/dt = x·µÄJx = 0</div>
                            <p>Kinetic energy (T) from node momenta and potential energy (V) from edge elongations exchange but their sum remains constant.</p>
                        </div>
                        
                        <div class="theory-card">
                            <h3>üîß Rectification</h3>
                            <p>The <em>divergence heuristic</em> repairs violations by:</p>
                            <div class="formula">‚àá¬∑F(node) = ‚àë‚±º B·µ¢‚±º</div>
                            <p>Nodes with positive divergence become sources (-1), balancing the flow and restoring Newton's 3rd Law.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Console Panel -->
            <div class="panel console-panel">
                <div class="panel-header">
                    <span class="panel-icon">üíª</span>
                    <h2>Console Output</h2>
                </div>
                <div class="panel-content">
                    <div class="console-output" id="console-output">
                        <div class="console-line info">Physics Engine Demo initialized. Load a preset or click cells to build a graph.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // =====================================================
        // INLINE PHYSICS ENGINE (for standalone demo)
        // =====================================================
        
        class PhysicsEngine {
            constructor(adjacencyMatrix, n = null, m = null) {
                this.sourceAdjMatrix = adjacencyMatrix;
                this.N = n || adjacencyMatrix.length;
                this.M = m || this._countEdges();
                this.matrix = null;
                this.incidenceMatrix = null;
                this.edgeList = [];
                this.stateVector = null;
                this._buildAugmentedSystem();
            }
            
            _countEdges() {
                let count = 0;
                const n = this.sourceAdjMatrix.length;
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        if (this.sourceAdjMatrix[i][j] === 1) count++;
                    }
                }
                return count;
            }
            
            _buildAugmentedSystem() {
                const n = this.N;
                const A = this.sourceAdjMatrix;
                
                this.edgeList = [];
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        if (A[i][j] === 1) {
                            this.edgeList.push([i, j]);
                        }
                    }
                }
                this.M = this.edgeList.length;
                
                const m = this.M;
                const dim = n + m;
                
                this.incidenceMatrix = Array(n).fill(null).map(() => Array(m).fill(0));
                this.matrix = Array(dim).fill(null).map(() => Array(dim).fill(0));
                
                for (let k = 0; k < m; k++) {
                    const [from, to] = this.edgeList[k];
                    this.incidenceMatrix[from][k] = -1;
                    this.incidenceMatrix[to][k] = 1;
                }
                
                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < m; j++) {
                        this.matrix[i][n + j] = this.incidenceMatrix[i][j];
                    }
                }
                
                for (let i = 0; i < m; i++) {
                    for (let j = 0; j < n; j++) {
                        this.matrix[n + i][j] = -this.incidenceMatrix[j][i];
                    }
                }
                
                this.stateVector = new Array(dim).fill(1.0);
            }
            
            audit() {
                const violations = [];
                const warnings = [];
                const n = this.N;
                const m = this.M;
                
                for (let edgeIdx = 0; edgeIdx < m; edgeIdx++) {
                    let colSum = 0;
                    const participants = [];
                    
                    for (let nodeIdx = 0; nodeIdx < n; nodeIdx++) {
                        const entry = this.incidenceMatrix[nodeIdx][edgeIdx];
                        if (entry !== 0) {
                            colSum += entry;
                            participants.push({ node: nodeIdx, value: entry });
                        }
                    }
                    
                    if (participants.length !== 2) {
                        violations.push({
                            type: 'EDGE_DEGREE_VIOLATION',
                            edge: edgeIdx,
                            participants: participants,
                            message: `Edge ${edgeIdx} connects ${participants.length} nodes (expected 2)`
                        });
                    } else if (Math.abs(colSum) > 1e-10) {
                        violations.push({
                            type: 'NEWTON_VIOLATION',
                            edge: edgeIdx,
                            nodes: participants.map(p => p.node),
                            colSum: colSum,
                            message: `Edge ${edgeIdx} violates Newton's 3rd Law: sum = ${colSum}`
                        });
                    }
                }
                
                let statusColor = violations.length === 0 ? 'GREEN' : 'ORANGE';
                
                return {
                    isPhysical: violations.length === 0,
                    violations: violations,
                    warnings: warnings,
                    statusColor: statusColor,
                    summary: { nodeCount: n, edgeCount: m, stateSpaceDim: n + m }
                };
            }
            
            calculateNodalDivergence(nodeIdx) {
                let divergence = 0;
                for (let j = 0; j < this.M; j++) {
                    divergence += this.incidenceMatrix[nodeIdx][j];
                }
                return divergence;
            }
            
            getAllDivergences() {
                const divergences = [];
                for (let i = 0; i < this.N; i++) {
                    divergences.push(this.calculateNodalDivergence(i));
                }
                return divergences;
            }
            
            autoRectify() {
                const auditBefore = this.audit();
                const rectifications = [];
                
                if (auditBefore.isPhysical) {
                    return { success: true, alreadyPhysical: true, rectifications: [], auditAfter: auditBefore };
                }
                
                for (const violation of auditBefore.violations) {
                    if (violation.type === 'NEWTON_VIOLATION') {
                        const edgeIdx = violation.edge;
                        const [n1, n2] = violation.nodes;
                        
                        const div1 = this.calculateNodalDivergence(n1);
                        const div2 = this.calculateNodalDivergence(n2);
                        
                        let sourceNode = div1 >= div2 ? n1 : n2;
                        let sinkNode = sourceNode === n1 ? n2 : n1;
                        
                        this.incidenceMatrix[sourceNode][edgeIdx] = -1;
                        this.incidenceMatrix[sinkNode][edgeIdx] = 1;
                        
                        this.matrix[sourceNode][this.N + edgeIdx] = -1;
                        this.matrix[sinkNode][this.N + edgeIdx] = 1;
                        this.matrix[this.N + edgeIdx][sourceNode] = 1;
                        this.matrix[this.N + edgeIdx][sinkNode] = -1;
                        
                        rectifications.push({ edge: edgeIdx, sourceNode, sinkNode });
                    }
                }
                
                return { success: true, alreadyPhysical: false, rectifications, auditAfter: this.audit() };
            }
            
            getHamiltonian(stateVec = null) {
                const x = stateVec || this.stateVector;
                const n = this.N;
                const m = this.M;
                
                let kineticEnergy = 0;
                let potentialEnergy = 0;
                
                for (let i = 0; i < n + m; i++) {
                    const componentEnergy = 0.5 * x[i] * x[i];
                    if (i < n) kineticEnergy += componentEnergy;
                    else potentialEnergy += componentEnergy;
                }
                
                return { total: kineticEnergy + potentialEnergy, kinetic: kineticEnergy, potential: potentialEnergy };
            }
            
            formatAugmentedMatrix() {
                const dim = this.N + this.M;
                let text = '';
                
                for (let i = 0; i < dim; i++) {
                    text += '‚îÇ ';
                    for (let j = 0; j < dim; j++) {
                        const val = this.matrix[i][j];
                        if (val === 0) text += '  . ';
                        else if (val === 1) text += ' +1 ';
                        else if (val === -1) text += ' -1 ';
                        else text += val.toFixed(1).padStart(4);
                    }
                    text += '‚îÇ';
                    if (i < this.N) text += ` p${i}`;
                    else text += ` q${i - this.N}`;
                    text += '\n';
                    if (i === this.N - 1) text += '‚îú' + '‚îÄ'.repeat(dim * 4 + 1) + '‚î§\n';
                }
                
                return text;
            }
        }
        
        // =====================================================
        // DEMO APPLICATION
        // =====================================================
        
        let currentMatrix = [];
        let matrixSize = 4;
        let engine = null;
        
        // Presets
        const PRESETS = {
            triangle: {
                size: 3,
                matrix: [
                    [0, 1, -1],
                    [-1, 0, 1],
                    [1, -1, 0]
                ]
            },
            square: {
                size: 4,
                matrix: [
                    [0, 1, 0, -1],
                    [-1, 0, 1, 0],
                    [0, -1, 0, 1],
                    [1, 0, -1, 0]
                ]
            },
            path4: {
                size: 4,
                matrix: [
                    [0, 1, 0, 0],
                    [-1, 0, 1, 0],
                    [0, -1, 0, 1],
                    [0, 0, -1, 0]
                ]
            },
            star4: {
                size: 5,
                matrix: [
                    [0, 1, 1, 1, 1],
                    [-1, 0, 0, 0, 0],
                    [-1, 0, 0, 0, 0],
                    [-1, 0, 0, 0, 0],
                    [-1, 0, 0, 0, 0]
                ]
            },
            k4: {
                size: 4,
                matrix: [
                    [0, 1, 1, 1],
                    [-1, 0, 1, 1],
                    [-1, -1, 0, 1],
                    [-1, -1, -1, 0]
                ]
            },
            broken: {
                size: 4,
                matrix: [
                    [0, 1, 0, 0],
                    [1, 0, 1, 0],  // Non-skew-symmetric on purpose
                    [0, 1, 0, 1],
                    [0, 0, 1, 0]
                ]
            }
        };
        
        function initMatrixInput() {
            const container = document.getElementById('matrix-input');
            container.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'matrix-input-grid';
            
            // Header row
            const headerRow = document.createElement('div');
            headerRow.className = 'matrix-row';
            headerRow.appendChild(createLabel(''));
            for (let j = 0; j < matrixSize; j++) {
                headerRow.appendChild(createLabel(j.toString()));
            }
            grid.appendChild(headerRow);
            
            // Matrix rows
            for (let i = 0; i < matrixSize; i++) {
                const row = document.createElement('div');
                row.className = 'matrix-row';
                row.appendChild(createLabel(i.toString()));
                
                for (let j = 0; j < matrixSize; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'matrix-cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    if (i === j) {
                        cell.classList.add('diagonal');
                        cell.textContent = '0';
                    } else {
                        cell.textContent = currentMatrix[i]?.[j] || '0';
                        updateCellStyle(cell, currentMatrix[i]?.[j] || 0);
                        cell.addEventListener('click', () => toggleCell(i, j));
                    }
                    
                    row.appendChild(cell);
                }
                
                grid.appendChild(row);
            }
            
            container.appendChild(grid);
        }
        
        function createLabel(text) {
            const label = document.createElement('div');
            label.className = 'matrix-label';
            label.textContent = text;
            return label;
        }
        
        function updateCellStyle(cell, value) {
            cell.classList.remove('positive', 'negative');
            if (value === 1) {
                cell.classList.add('positive');
                cell.textContent = '+1';
            } else if (value === -1) {
                cell.classList.add('negative');
                cell.textContent = '-1';
            } else {
                cell.textContent = '0';
            }
        }
        
        function toggleCell(i, j) {
            if (i === j) return;
            
            const current = currentMatrix[i][j];
            let newVal;
            
            if (current === 0) newVal = 1;
            else if (current === 1) newVal = -1;
            else newVal = 0;
            
            // Update matrix (maintain skew-symmetry)
            currentMatrix[i][j] = newVal;
            currentMatrix[j][i] = -newVal;
            
            // Update UI
            const cell1 = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
            const cell2 = document.querySelector(`[data-row="${j}"][data-col="${i}"]`);
            
            updateCellStyle(cell1, newVal);
            updateCellStyle(cell2, -newVal);
            
            logMessage('info', `Toggled edge (${i},${j}): ${newVal === 0 ? 'removed' : newVal === 1 ? 'i‚Üíj' : 'j‚Üíi'}`);
        }
        
        window.loadPreset = function(name) {
            const preset = PRESETS[name];
            if (!preset) return;
            
            matrixSize = preset.size;
            currentMatrix = preset.matrix.map(row => [...row]);
            
            initMatrixInput();
            logMessage('success', `Loaded preset: ${name} (${matrixSize} vertices)`);
        };
        
        window.runAudit = function() {
            if (!currentMatrix || currentMatrix.length === 0) {
                logMessage('error', 'No matrix to audit. Load a preset first.');
                return;
            }
            
            engine = new PhysicsEngine(currentMatrix);
            const report = engine.audit();
            const energy = engine.getHamiltonian();
            const divergences = engine.getAllDivergences();
            
            updateStatusCard(report);
            updateDimensions(report);
            updateEnergy(energy);
            updateViolations(report);
            updateDivergence(divergences);
            updateAugmentedMatrix(engine);
            
            document.getElementById('rectify-btn').disabled = report.isPhysical;
            
            if (report.isPhysical) {
                logMessage('success', `‚úì Graph is physically realizable! N=${report.summary.nodeCount}, M=${report.summary.edgeCount}`);
            } else {
                logMessage('warning', `‚úó Found ${report.violations.length} violation(s). Click Rectify to fix.`);
            }
        };
        
        window.runRectify = function() {
            if (!engine) {
                logMessage('error', 'Run audit first.');
                return;
            }
            
            const result = engine.autoRectify();
            
            if (result.alreadyPhysical) {
                logMessage('info', 'Graph is already physical. No changes needed.');
                return;
            }
            
            logMessage('success', `‚úì Rectified ${result.rectifications.length} edge(s)`);
            
            // Update displays
            const energy = engine.getHamiltonian();
            const divergences = engine.getAllDivergences();
            
            updateStatusCard(result.auditAfter);
            updateDimensions(result.auditAfter);
            updateEnergy(energy);
            updateViolations(result.auditAfter);
            updateDivergence(divergences);
            updateAugmentedMatrix(engine);
            
            document.getElementById('rectify-btn').disabled = result.auditAfter.isPhysical;
        };
        
        function updateStatusCard(report) {
            const card = document.getElementById('status-card');
            const isPhysical = report.isPhysical;
            
            card.innerHTML = `
                <div class="status-icon">${isPhysical ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                <div class="status-text ${isPhysical ? 'physical' : 'non-physical'}">
                    ${isPhysical ? 'Physically Realizable' : 'Non-Physical'}
                </div>
                <div class="status-subtitle">
                    ${isPhysical ? 'Newton\'s 3rd Law satisfied' : `${report.violations.length} violation(s) found`}
                </div>
            `;
        }
        
        function updateDimensions(report) {
            document.getElementById('dim-n').textContent = report.summary.nodeCount;
            document.getElementById('dim-m').textContent = report.summary.edgeCount;
            document.getElementById('dim-total').textContent = report.summary.stateSpaceDim;
        }
        
        function updateEnergy(energy) {
            const total = energy.total || 1;
            const kPct = (energy.kinetic / total) * 100;
            const pPct = (energy.potential / total) * 100;
            
            document.getElementById('energy-kinetic-bar').style.width = kPct + '%';
            document.getElementById('energy-potential-bar').style.width = pPct + '%';
            document.getElementById('kinetic-val').textContent = energy.kinetic.toFixed(3);
            document.getElementById('potential-val').textContent = energy.potential.toFixed(3);
            document.getElementById('total-energy').textContent = energy.total.toFixed(3);
        }
        
        function updateViolations(report) {
            const panel = document.getElementById('violations-panel');
            const list = document.getElementById('violations-list');
            
            if (report.violations.length > 0) {
                panel.style.display = 'block';
                list.innerHTML = report.violations.map(v => `<li>${v.message}</li>`).join('');
            } else {
                panel.style.display = 'none';
            }
        }
        
        function updateDivergence(divergences) {
            const grid = document.getElementById('divergence-grid');
            grid.innerHTML = divergences.map((d, i) => {
                const cls = d > 0 ? 'positive' : d < 0 ? 'negative' : 'zero';
                const sign = d > 0 ? '+' : '';
                return `
                    <div class="div-cell ${cls}">
                        <span class="div-cell-label">v${i}</span>
                        <span class="div-cell-value">${sign}${d}</span>
                    </div>
                `;
            }).join('');
        }
        
        function updateAugmentedMatrix(engine) {
            document.getElementById('matrix-dims').textContent = 
                `(${engine.N}+${engine.M}) √ó (${engine.N}+${engine.M}) = ${engine.N + engine.M} √ó ${engine.N + engine.M}`;
            document.getElementById('augmented-matrix').textContent = engine.formatAugmentedMatrix();
        }
        
        function logMessage(type, message) {
            const console = document.getElementById('console-output');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        
        // Initialize
        currentMatrix = [
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0]
        ];
        initMatrixInput();
        
        // Load a default preset
        window.loadPreset('triangle');
    </script>
</body>
</html>
